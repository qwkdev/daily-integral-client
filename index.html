<!DOCTYPE html>
<html lang="en">
<head>
	<title>ddx.today</title>
	<style>
		:root {
			--u: 2vw;

			--modal-bg: #06060888;
			--bg: #161618;
			--bg2: #2a2a2b;
			--bg3: #444445;
			--bg4: #777779;

			--grid: round(calc(2 * var(--u)), 10px);
		}
		*::selection {
			background: #fff7;
		}
		*[hidden] {
			display: none !important;
		}

		.btn {
			--btn-h: var(--h);
			--btn-s: var(--s);
			--btn-l: var(--l);
			--br: calc(.5 * var(--u));
			--border: calc(.15 * var(--u));

			box-sizing: border-box;
			font-family: monospace;
			font-size: calc(2 * var(--u));
			color: #fff;

			background: hsl(var(--btn-h), calc(83% * var(--btn-s)), calc(57% * var(--btn-l)));
			border: var(--border) solid hsl(var(--btn-h), calc(70% * var(--btn-s)), calc(48% * var(--btn-l)));
			border-radius: var(--br);
			box-shadow:
				0 calc(var(--border)/2) calc(var(--border)/2) var(--border) hsla(var(--btn-h), calc(72% * var(--btn-s)), calc(30% * var(--btn-l)), 0.2),
				inset 0 calc(-1 * var(--border)) var(--border) 0 hsl(var(--btn-h), calc(70% * var(--btn-s)), calc(48% * var(--btn-l))),
				inset 0 0 0 var(--border) hsl(var(--btn-h), calc(92% * var(--btn-s)), calc(62% * var(--btn-l)));

			transition: .2s;
		}
		.btn:hover {
			--btn-l: calc(var(--l) * 1.05);
		}
		.btn:focus {
			outline: none;
		}

		body {
			margin: 0;
			background: var(--bg);
			background-image: linear-gradient(0deg, var(--bg2) 0, var(--bg2) 1px, transparent 1px, transparent 100%),
						linear-gradient(90deg, var(--bg2) 0, var(--bg2) 1px, transparent 1px, transparent 100%);
			background-size: var(--grid) var(--grid);
		}

		#grid {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			box-sizing: border-box;

			display: grid;
			grid-template-columns: 1fr 1fr;

			padding: round(calc(3 * var(--u)), 10px);
			gap: calc(1 * var(--u));
		}
		.panel {
			width: 100%;
			height: 100%;
			background: var(--bg);
			border: 1px solid var(--bg2);
			padding: calc(1 * var(--u));
			box-sizing: border-box;
			font-family: monospace;
			color: #fff;
			position: relative;
		}
		.panel h1, .panel h2, .panel h3, .panel p {
			margin: 0;
		}
		.panel h1 {
			font-size: calc(3 * var(--u));
			font-weight: 700;
			margin-bottom: calc(.5 * var(--u));
		}
		.panel h2 {
			font-size: calc(1.5 * var(--u));
			font-weight: 700;
		}
		.panel h3, .panel p {
			font-size: calc(1.2 * var(--u));
			font-weight: 500;
		}
		.panel .center {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		input {
			width: 100%;

			box-sizing: border-box;
			padding: calc(.5 * var(--u));
			background: var(--bg2);
			border: 1px solid var(--bg3);

			font-family: monospace;
			font-size: calc(1.5 * var(--u));
			color: #fff;
			transition: .3s;

			&:focus {
				outline: none;
				border-color: var(--bg4);
			}
			&::placeholder {
				color: var(--bg4);
			}
		}

		input::-webkit-outer-spin-button,
		input::-webkit-inner-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}
		input[type=number] {
			-moz-appearance: textfield;
			appearance: textfield;
		}


		.topic {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: calc(.5 * var(--u));

			.btn {
				width: 100%;
				font-size: calc(2 * var(--u));
				padding: calc(.8 * var(--u)) 0;
			}
		}

		.clr1 {
			--h: 220;
			--s: 1;
			--l: 1;
		}
		.clr2 {
			--h: 120;
			--s: .8;
			--l: .75;
		}
		.clr3 {
			--h: 35;
			--s: 1;
			--l: 1;
		}
		.clr4 {
			--h: 0;
			--s: .8;
			--l: .6;
		}

		.action {
			--h: 250;
			--s: 1;
			--l: 1;
		}
		.action1 {
			--h: 135;
			--s: .7;
			--l: .8;
		}
		.action2 {
			--h: 0;
			--s: .8;
			--l: .5;
		}

		.dropdown {
			width: 100%;
			height: max-content;

			box-sizing: border-box;
			border: 1px solid var(--bg2);
			font-family: monospace;
			color: #fff;
			position: relative;
			padding: calc(1 * var(--u));

			.toggle {
				position: relative;
				font-size: calc(2 * var(--u));
				
				svg {
					height: 80%;
					width: auto;
					position: absolute;
					top: 10%;
					right: 1%;
					transition: .2s;
					stroke: #fff;
				}
				&:has(+ .content[hidden]) svg {
					top: 9%;
					right: .5%;
					transform: rotate(-90deg);
				}
			}
			.content {
				margin-top: calc(1 * var(--u));
				font-size: calc(1 * var(--u));

				p {
					margin: 0;
				}
				b {
					font-weight: 700;
				}
			}
		}

		#title, #day-select {
			display: flex;
			align-items: center;
			gap: calc(1 * var(--u));
		}
		.num {
			display: flex;
			align-items: center;
			height: 100%;
			gap: calc(.75 * var(--u));

			p {
				font-size: calc(1.5  * var(--u));
			}
			.btn {
				--h: 0;
				--s: 0;
				--l: .6;
			}
			button {
				padding: 0;
				display: flex;
				align-items: center;
				justify-content: center;
				width: calc(2.5 * var(--u));
				height: calc(2.5 * var(--u));
			}
			.minus {
				padding-bottom: calc(.3 * var(--u));
			}
		}

		dialog {
			position: absolute;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			background: var(--modal-bg);

			.modal {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);

				width: calc(40 * var(--u));
				height: max-content;
				max-height: 80vh;
				overflow-y: scroll;

				box-sizing: border-box;
				background: var(--bg);
				border: 1px solid var(--bg2);
				padding: calc(1 * var(--u));
				font-family: monospace;
				color: #fff;
				position: relative;

				display: flex;
				flex-direction: column;
				align-items: center;
				gap: calc(1 * var(--u));

				h1 {
					font-size: calc(2 * var(--u));
					font-weight: 700;
					margin: 0;

					display: flex;
					gap: calc(1 * var(--u));
					align-items: center;

					span {
						font-size: calc(1.5 * var(--u));
						padding: calc(.2 * var(--u)) calc(.5 * var(--u)) calc(.3 * var(--u)) calc(.5 * var(--u));
					}
				}

				#puzzle {
					width: 100%;
					height: max-content;
					flex: 0 0 auto;

					box-sizing: border-box;
					border: 1px solid var(--bg2);
					padding: calc(1 * var(--u));
					padding-bottom: calc(.9 * var(--u));
					font-family: monospace;
					color: #fff;
					position: relative;

					overflow-x: scroll;
					font-size: calc(1.2 * var(--u));

					display: flex;
					justify-content: center;
					flex-direction: column;

					.math-block {
						height: max-content !important;
					}
				}

				#check {
					width: 100%;
					display: flex;
					gap: calc(.5 * var(--u));

					button {
						font-size: calc(1.5 * var(--u));
						padding: calc(.2 * var(--u)) calc(.5 * var(--u)) calc(.3 * var(--u)) calc(.5 * var(--u));
					}
				}

				.dropdown .content {
					height: max-content;
					/* max-height: 20vh; */
					overflow-y: scroll;
				}
			}
		}

		@media only screen and (min-aspect-ratio: 1/1) {
			:root {
				--u: 1.4vh;
			}
			#grid {
				grid-template-columns: repeat(6, 1fr);
			}
			#title {
				grid-column: 1 / 4;
			}
			#day-select {
				grid-column: 4 / 7;
			}
			.topic, #loading {
				grid-column: span 2;
			}
			dialog .modal {
				width: calc(70 * var(--u));

				#puzzle {
					font-size: calc(1.75 * var(--u));
				}
			}
			.dropdown .content {
				font-size: calc(1.5 * var(--u));
			}
		}
	</style>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
	<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
</head>
<body>
	<div id="grid">
		<div class="panel" id="title">
			<h2>ddx.today &bullet; v1.0</h2>
		</div>
		<div class="panel" id="day-select">
			<h2>Day:</h2>
			<div class="num">
				<!-- <button class="btn minus" onclick="changeDay(-1)">-</button> -->
				<p id="day"></p>
				<!-- <button class="btn" onclick="changeDay(1)">+</button> -->
			</div>
		</div>

		<div class="panel" id="loading">
			<h2>Loading...</h2>
		</div>

		<div class="panel topic" id="integral" hidden>
			<h1>Integration</h1>
			<!-- <div class="logo" id="ilogo">&int;</div> -->
			<button class="btn clr1" onclick="loadPuzzle(this)" data-value="beginner">Beginner</button>
			<button class="btn clr2" onclick="loadPuzzle(this)" data-value="easy">Easy</button>
			<button class="btn clr3" onclick="loadPuzzle(this)" data-value="medium">Medium</button>
			<button class="btn clr4" onclick="loadPuzzle(this)" data-value="hard">Hard</button>
		</div>
		<div class="panel topic" id="derivative" hidden>
			<h1>Derivatives</h1>
			<button class="btn clr2" onclick="loadPuzzle(this)" data-value="easy">Easy</button>
			<button class="btn clr3" onclick="loadPuzzle(this)" data-value="medium">Medium</button>
			<button class="btn clr4" onclick="loadPuzzle(this)" data-value="hard">Hard</button>
		</div>
		<div class="panel topic" id="limit" hidden>
			<h1>Limits</h1>
			<button class="btn clr1" onclick="loadPuzzle(this)" data-value="limit">Limit</button>
		</div>
	</div>

	<dialog id="question-modal">
		<div class="modal">
			<h1 id="puzzleHeader"></h1>

			<div id="puzzle"></div>
			<div id="check">
				<input id="answer-input" type="text" inputmode="decimal" placeholder="Type answer here..." oninput="fixInput(this)">
				<button id="answer-check" class="btn action1">Check</button>
			</div>
			
			<div class="dropdown" onclick="dropdown(this)">
				<div class="toggle">Hint 1<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path d="M6 9L12 15L18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></div>
				<div class="content" hidden>
					<p id="hint1"></p>
				</div>
			</div>
			<div class="dropdown" onclick="dropdown(this)">
				<div class="toggle">Hint 2<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path d="M6 9L12 15L18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></div>
				<div class="content" hidden>
					<p id="hint2"></p>
				</div>
			</div>
			<div class="dropdown" onclick="dropdown(this)">
				<div class="toggle">Solution<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path d="M6 9L12 15L18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></div>
				<div class="content" id="solution" hidden></div>
			</div>
		</div>
	</dialog>

	<script>
		const SERVER = 'https://api.ddx.today';

		const timezone = 'Australia/Sydney';
		const startDate = new Date(new Date("2025-09-16").toLocaleString("en-US", { timeZone: timezone }));
		function getDate(isoDate) {
			const target = new Date(
				new Date(...(isoDate ? [isoDate] : [])).toLocaleString("en-US", { timeZone: timezone })
			);
			return Math.floor((target - startDate) / (24 * 60 * 60 * 1000)) + 2;
		}

		let day = getDate();
		document.getElementById('day').innerText = day;

		function titleCase(text) {
			if (!text) return '';
			return text[0].toUpperCase() + text.toLowerCase().slice(1);
		}

		function fixInput(ele) {
			ele.value = ele.value.replace(/[^0-9.-]/g, '');
			ele.style.cssText = '';
		}

		function dropdown(ele) {
			const content = ele.querySelector('.content');
			content.hidden = !content.hidden;
		}

		function renderMath(latex, parent) {
			parent.innerHTML = '';

			const math = latex.trim().replaceAll('\n', ' \\\\ ');
			const parts = math.split(' \\\\  \\\\ ');
			parts.forEach(part => {
				const div = document.createElement('div');
				div.classList.add('math-block');
				katex.render(part, div, {
					throwOnError: false,
					displayMode: true
				});
				parent.appendChild(div);
			});
		}

		function arrayStrip(array, compare) {
			let start = 0;
			let end = array.length - 1;

			while (start <= end && compare(array[start])) start++;
			while (end >= start && compare(array[end])) end--;
			return array.slice(start, end + 1);
		}

		function renderPart(parent, type, text) {
			let lastChild = Array.from(parent.children).at(-1);
			if (type === 'math') {
				const math = document.createElement('div');
				renderMath(text, math);
				parent.appendChild(math);
			} else if (type === 'newblock') {
				const newBlock = document.createElement('p');
				newBlock.textContent = text;
				parent.appendChild(newBlock);
			} else {
				if (lastChild?.tagName !== 'P') {
					const newP = document.createElement('p');
					parent.appendChild(newP);
					lastChild = newP;
				}
				if (type === 'newline') {
					const newLine = document.createElement('br');
					lastChild.appendChild(newLine);
				} else if (type === 'bold') {
					const newBold = document.createElement('b');
					newBold.textContent = text;
					lastChild.appendChild(newBold);
				} else {
					lastChild.innerHTML += text;
				}
			}
		}
		function renderMarkdown(md, parent) {
			parent.innerHTML = '';

			let parts = [];

			let type = 'text';
			let buffer = '';
			for (const char of md) {
				if (type === 'text' && char === '\n') {
					if (buffer) parts.push([type, buffer]);
					if (['newline', 'newblock'].includes(parts.at(-1)?.[0])) {
						parts.pop();
						parts.push(['newblock', null]);
					} else {
						parts.push(['newline', null]);
						buffer = '';
					}
				} else if (type !== 'math' && char === '*' && buffer.at(-1) === '*') {
					parts.push([type, buffer.slice(0, -1)]);
					type = type === 'bold' ? 'text' : 'bold';
					buffer = '';
				} else if (char === '$') {
					parts.push([type, buffer]);
					type = type === 'math' ? 'text' : 'math';
					buffer = '';
				} else {
					buffer += char;
				}
			}

			parts = parts.filter(e => e[0] !== '' && e[1] !== '');
			parts = arrayStrip(parts, e => ['newline', 'newblock'].includes(e[0]));

			parts.map(([type, text]) => renderPart(parent, type, text));
		}
		
		function checkAnswer(answers) {
			const answerInput = document.getElementById('answer-input');
			const answer = answerInput.value.trim();

			answerInput.style.cssText = `border-color: ${answers.includes(answer) ? '#0f0' : '#f00'};`;
		}

		let apiData = {}

		const grid = document.getElementById('grid');
		function init(data) {
			apiData = data;
			document.getElementById('loading').hidden = true;
			grid.querySelectorAll('.topic').forEach(t => {
				t.querySelectorAll('.btn').forEach(l => {
					const info = data[t.id][l.dataset.value];
					if (!info) l.remove();
				})

				t.hidden = false;
			});
		}

		const questionModal = document.getElementById('question-modal');
		questionModal.addEventListener('click', e => {
			if (e.target === questionModal) questionModal.close();
		});

		const puzzle = document.getElementById('puzzle');
		const hint1 = document.getElementById('hint1');
		const hint2 = document.getElementById('hint2');
		const solutionContent = document.getElementById('solution');
		const puzzleHeader = document.getElementById('puzzleHeader');
		function loadPuzzle(ele) {
			const level = ele.dataset.value;
			const prettyLevel = ele.textContent;
			const clr = Array.from(ele.classList).filter(e => e.startsWith('clr'))[0];
			const type = ele.parentElement.id;
			const info = apiData[type][level];

			puzzleHeader.innerHTML = '';
			const levelSpan = document.createElement('span');
			levelSpan.classList.add('btn', clr);
			levelSpan.textContent = prettyLevel;
			puzzleHeader.appendChild(levelSpan);
			puzzleHeader.appendChild(document.createTextNode(titleCase(type)));

			renderMath(info.latex, puzzle);

			document.getElementById('answer-input').value = '';
			document.getElementById('answer-input').style.cssText = '';
			document.getElementById('answer-check').onclick = () => checkAnswer(info.answers);

			hint1.parentElement.hidden = true;
			hint2.parentElement.hidden = true;
			solutionContent.hidden = true;

			hint1.innerText = info.hints?.[0] ?? '';
			hint2.innerText = info.hints?.[1] ?? '';

			renderMarkdown(info.solution, solutionContent);

			questionModal.showModal();
		}

		fetch(`${SERVER}/${day}`)
			.then(resp => resp.json())
			.then(init)
			.catch(e => console.error('Error:', e));
	</script>
	<script>
		fetch('https://qtrack.pythonanywhere.com/visit/ddx', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
				's': null,
				'o': window.location.href || null,
				'r': document.referrer || null
			})
		}).catch(error => console.error('Error fetching visits:', error));
	</script>
</body>
</html>